name: Build IJKPlayer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  build:
    runs-on: ubuntu-18.04
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git yasm make
    
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r10e
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      
    - name: Configure environment
      run: |
        echo "export PATH=$ANDROID_SDK_ROOT/platform-tools:$PATH" >> $GITHUB_ENV
        echo "export PATH=$ANDROID_SDK_ROOT/tools:$PATH" >> $GITHUB_ENV
        echo "export ANDROID_NDK=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        echo "export PATH=$ANDROID_NDK_ROOT:$PATH" >> $GITHUB_ENV
      
    - name: Clone IJKPlayer
      run: git clone https://github.com/Bilibili/ijkplayer.git ijkplayer-android
      
    - name: Initialize IJKPlayer
      run: |
        cd ijkplayer-android
        ./init-android.sh
        ./init-android-openssl.sh
        
    - name: Build OpenSSL
      run: |
        cd ijkplayer-android/android/contrib
        ./compile-openssl.sh clean
        ./compile-openssl.sh all
        
    - name: Build FFmpeg
      run: |
        cd ijkplayer-android/android/contrib
        ./compile-ffmpeg.sh clean
        ./compile-ffmpeg.sh all
        
    - name: Build IJKPlayer
      run: |
        cd ijkplayer-android/android
        ./compile-ijk.sh all
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v2
      with:
        name: ijkplayer-android
        path: ijkplayer-android/android/ijkplayer
